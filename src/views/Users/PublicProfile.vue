<template>
  <v-container
    id="userPage"
    fluid
    class="standard grey lighten-3 pb-10"
  >
    <v-row v-if="messages()['getPublicUser'].message">
      <v-col cols="12">
        <v-alert
          type="success"
          class="mb-0"
          dismissible
        >
          {{ messages()['getPublicUser'].message }}
        </v-alert>
      </v-col>
    </v-row>

    <div v-if="error">
      <NotFound />
    </div>

    <v-row v-else>
      <v-col cols="12">
        <v-toolbar
          flat
          color="primary"
          dark
          height="55"
        >
          <v-toolbar-title>
            User Profile for {{ userData.user.username }}
          </v-toolbar-title>
          <v-spacer />
          <user-profile-menu
            :viewing-id="Number($route.params.id)"
          />
        </v-toolbar>
      </v-col>
      <v-col
        v-if="!loading"
        cols="12"
      >
        <v-container
          fluid
          class="py-0 pa-0"
        >
          <v-row>
            <v-col
              cols="12"
              xl="2"
              lg="6"
              md="12"
              sm="12"
              xs="12"
              class="pt-0"
            >
              <v-card
                class="d-flex flex-column rounded-0"
                height="100%"
              >
                <v-card-title class="primary white--text py-3">
                  Personal Information
                </v-card-title>
                <v-card-text class="pt-3 pb-0">
                  <v-list>
                    <v-list-item
                      v-for="(field, fieldName, fieldKey) in getPublicUserMeta"
                      :key="'userMeta' + fieldKey"
                      class="body-1"
                    >
                      <v-list-item-content
                        v-if="fieldName !== 'preferences' && fieldName!=='orcid'"
                        class="py-0 d-block"
                      >
                        <b class="blue--text">{{ fieldName | cleanString }}: </b>
                        <span v-if="field && fieldName!=='orcid'"> {{ field }} </span>
                        <span v-else> None </span>
                      </v-list-item-content>
                      <v-list-item-content
                        v-else-if="fieldName==='preferences'"
                        class="py-2"
                      >
                        <b class="blue--text">{{ fieldName | cleanString }}: </b>
                        <ul>
                          <li
                            v-for="(pref, prefName, prefKey) in field"
                            :key="'pref_' + prefKey"
                          >
                            {{ prefName | cleanString }}: {{ booleanToString(pref) }}
                          </li>
                        </ul>
                      </v-list-item-content>
                      <v-list-item-content
                        v-else-if="fieldName==='orcid'"
                        class="d-block py-0"
                      >
                        <div class="d-flex align-center">
                          <b
                            class="blue--text"
                            style="margin-right: 0.2rem"
                          >{{ fieldName | cleanString }}: </b>
                          <a
                            v-if="field"
                            class="d-flex align-center underline-effect"
                            :href="`https://orcid.org/${field}`"
                            target="_blank"
                          >
                            <Icon
                              :height="20"
                              item="Orcid"
                              wrapper-class=""
                            />
                            <span class="ml-1">{{ field }}</span>
                          </a>
                        </div>
                      </v-list-item-content>
                    </v-list-item>
                  </v-list>
                </v-card-text>
              </v-card>
            </v-col>

            <v-col
              class="pt-0"
              cols="12"
              xl="6"
              lg="6"
              md="12"
              sm="12"
              xs="12"
            >
              <v-card
                height="100%"
                class="d-flex flex-column rounded-0"
              >
                <v-card-title class="primary white--text py-3">
                  Most recent publications
                </v-card-title>
                <v-card-text
                  class="pt-3 pb-0"
                  style="flex-grow: 1"
                >
                  <v-list v-if="publications.length > 0">
                    <v-list-item
                      v-for="(pub, index) in publications"
                      :key="'pub_' + index"
                    >
                      <v-list-item-content>
                        <v-list-item-title>
                          <a
                            v-if="pub.url"
                            :href="pub.url"
                            rel="noreferrer"
                            target="_blank"
                          >{{ pub.title }}</a>
                          <span v-else> {{ pub.title }} (No available link)</span>
                        </v-list-item-title>
                      </v-list-item-content>
                    </v-list-item>
                  </v-list>
                  <div v-if="publications.length === 0 && !loading">
                    This user does not have any publications listed on ORCID.
                  </div>
                </v-card-text>
                <v-card-actions>
                  <v-btn
                    v-if="userData.user.orcid && !loading"
                    :href="`https://orcid.org/${userData.user.orcid}`"
                    rel="external"
                    target="_blank"
                  >
                    View ORCID profile
                  </v-btn>
                </v-card-actions>
              </v-card>
            </v-col>

            <v-col
              cols="12"
              xl="4"
              lg="6"
              md="6"
              sm="12"
              xs="12"
              class="pt-0"
            >
              <v-card
                height="100%"
                class="d-flex flex-column rounded-0"
              >
                <v-card-title class="primary white--text py-3">
                  Maintained Records
                </v-card-title>
                <v-card-text
                  class="pa-0"
                  style="flex-grow: 1"
                >
                  <RecordsTable
                    :records="userData.user.maintainedRecords"
                    source="publicMaintainedRecords"
                  />
                </v-card-text>
              </v-card>
            </v-col>

            <v-col
              cols="12"
              xl="4"
              lg="6"
              md="6"
              sm="12"
              xs="12"
              class="pt-0"
            >
              <v-card
                height="100%"
                class="d-flex flex-column rounded-0"
              >
                <v-card-title class="primary white--text py-3">
                  Record Edits
                </v-card-title>
                <v-card-text
                  class="pa-0"
                  style="flex-grow: 1"
                >
                  <EditsTable
                    :edits="userData.user.editEvents"
                  />
                </v-card-text>
              </v-card>
            </v-col>

            <v-col
              cols="12"
              xl="4"
              lg="6"
              md="12"
              sm="12"
              xs="12"
              class="pt-0"
            >
              <v-card
                height="100%"
                class="d-flex flex-column rounded-0"
              >
                <v-card-title class="primary white--text py-3">
                  Organisations
                </v-card-title>
                <v-card-text
                  class="pa-0"
                  style="flex-grow: 1"
                >
                  <ViewOrganisations
                    :organisations="userData.user.organisations"
                  />
                </v-card-text>
              </v-card>
            </v-col>
          </v-row>
        </v-container>
      </v-col>
    </v-row>
    <v-fade-transition>
      <v-overlay
        v-if="loading"
        :absolute="false"
        opacity="0.8"
      >
        <loaders />
      </v-overlay>
    </v-fade-transition>
  </v-container>
</template>

<script>
    import { mapActions, mapState } from "vuex"
    import UserProfileMenu from "@/components/Users/UserProfileMenu";
    import Loaders from "@/components/Navigation/Loaders";
    import ExternalClient from "@/lib/Client/ExternalClients.js"
    import NotFound from "@/views/Errors/404"
    import RecordsTable from "../../components/Users/Profiles/Private/RecordsTable";
    import EditsTable from "../../components/Users/Profiles/Private/EditsTable";
    import { cleanString } from "@/utils/stringUtils"
    import ViewOrganisations from "@/components/Users/Profiles/Private/ViewOrganisations";
    import Icon from "@/components/Icon";

    let client = new ExternalClient();

    /**
     * @vue-data {Object} hideFields - an array of field to NOT display
     * */

    export default {
      name: "PublicProfile",
      components: {ViewOrganisations, RecordsTable, EditsTable, Loaders, NotFound, UserProfileMenu, Icon},
      mixins: [cleanString],
      data: () => {
        return {
            panel: 0,
            loading: false,
            error: false,
            publications: [],
            activeTab: 0,
            userData: {
              user: {
                username: 'none'
              }
            }
        }
      },
      computed: {
        ...mapState('users', ['user', "messages"]),
        ...mapState('editor', ['icons']),
        getPublicUserMeta: function(){
          let userMeta = JSON.parse(JSON.stringify(this.userData.user));
          delete userMeta["maintainedRecords"];
          delete userMeta["organisations"];
          delete userMeta["editEvents"];
          return userMeta;
        },
      },
      async created(){
          this.loading = true;
          let userId = this.$route.params.id;
          let data = await this.getPublicUser(userId);
          if (data == null || data.user == null){
            // No userdata, so don't look for publications.
            this.publications = [];
            this.error = true;
          }
          else {
            // Get user's publications.
            this.userData = data;
            this.publications = await this.getPublications();
          }
          this.loading = false;
      },
      methods: {
          ...mapActions('users', ['getPublicUser', 'setError']),
          async getPublications(){
            let output = [];
            if (this.userData.user.orcid) {
              let publications = await client.getOrcidUser(this.userData.user.orcid);
              /* istanbul ignore if */
              if (publications.error) {
                return [];
              }
              else {
                output = publications['activities-summary']['works']['group']
                    .slice(0, 7)
                    .map(obj => {
                      let url = null;
                      if (obj['work-summary'][0]['external-ids'] && obj['work-summary'][0]['external-ids']['external-id']) {
                        let DOI = obj['work-summary'][0]['external-ids']['external-id'].filter(
                            obj => obj['external-id-type'] = "doi"
                        )[0];
                        // See ORCIDpub.json
                        url = null;
                        /* istanbul ignore next */
                        if (DOI) {
                          url = DOI['external-id-url'] ? DOI['external-id-url'].value : null
                        }
                      }
                      return {
                        title: obj['work-summary'][0].title.title.value,
                        url: url
                      }
                    });
              }
            }
            return output;
          },

      },

    }
</script>

<style scoped>
  #userPage .text-truncate {
    max-width: 80%;
  }

  #userPage .v-toolbar {
    display: block !important;
    flex: initial !important;
  }

  #userPage .v-slide-group__wrapper {
    box-shadow: 0 3px 1px -2px rgba(0, 0, 0, 0.2), 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12);
    max-height: 71vh;
  }

  #userPage .v-tabs .v-item-group {
    position: initial !important;
  }

  #userPage .v-window.v-item-group {
    min-height: 70vh;
    background: #EEEEEE !important;
  }

  #userPage .v-tabs-bar {
    background-color: #EEEEEE !important
  }

  #userPage .v-slide-group__wrapper {
    background-color: white !important;
  }

</style>
